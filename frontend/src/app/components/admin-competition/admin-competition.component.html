<div class="container card">
  <h1>إضافة مسابقة جديدة</h1>

  <!-- Wizard Step Indicators -->
  <div class="steps">
    <div [class.active]="currentStep === 1">1. المعلومات الأساسية</div>
    <div [class.active]="currentStep === 2">2. الفئات والجنس</div>
    <div [class.active]="currentStep === 3">3. المراجعة</div>
  </div>

  <!-- Step 1 -->
  <div *ngIf="currentStep === 1">
    <form [formGroup]="competitionForm">
      <label>اسم المسابقة</label>
      <input formControlName="title" type="text" />

      <label>نوع المسابقة</label>
      <select formControlName="type">
        <option value="local">محلية</option>
        <option value="regional">إقليمية</option>
        <option value="national">وطنية</option>
        <option value="international">دولية</option>
      </select>

      <label>تاريخ البداية</label>
      <input type="datetime-local" formControlName="startDate" />

      <label>تاريخ النهاية</label>
      <input type="datetime-local" formControlName="endDate" />
    </form>
  </div>

  <!-- Step 2 -->
  <div *ngIf="currentStep === 2">
    <h3>اختيار الفئات والجنس</h3>
    <div *ngFor="let cat of categories">
      <label>
        <input
          type="checkbox"
          [value]="cat._id"
          (change)="onCategoryChange($event)"
          [checked]="competitionForm.value.categoryIds.includes(cat._id)"
        />
        {{ cat.name }}
      </label>

      <div *ngIf="competitionForm.value.categoryIds.includes(cat._id)" class="config-box">
        <label><input type="checkbox" (change)="toggleGender(cat._id, 'male', $event)" /> ذكور</label>
        <label><input type="checkbox" (change)="toggleGender(cat._id, 'female', $event)" /> إناث</label>
        <label><input type="checkbox" (change)="toggleGender(cat._id, 'children', $event)" /> أطفال</label>

        <div *ngIf="genderConfig[cat._id]?.children?.active">
          <label>مجموعات الأعمار:</label>
          <select multiple (change)="updateChildrenAgeGroups(cat._id, $event)">
            <option *ngFor="let g of allAgeGroups" [value]="g._id">{{ g.name }}</option>
          </select>
        </div>
      </div>
      <hr />
    </div>
  </div>

  <!-- Step 3 -->
  <div *ngIf="currentStep === 3">
    <h3>مراجعة البيانات قبل الحفظ</h3>
    <p><strong>اسم المسابقة:</strong> {{ competitionForm.value.title }}</p>
    <p><strong>النوع:</strong> {{ competitionForm.value.type }}</p>
    <p><strong>الفترة:</strong> {{ competitionForm.value.startDate }} → {{ competitionForm.value.endDate }}</p>

    <p><strong>الفئات:</strong></p>
    <ul>
      <li *ngFor="let catId of competitionForm.value.categoryIds">
        {{ getCategoryNameById(catId) }}:
        <span *ngIf="genderConfig[catId]?.male">ذكور </span>
        <span *ngIf="genderConfig[catId]?.female">إناث </span>
        <span *ngIf="genderConfig[catId]?.children?.active">
          أطفال ({{ genderConfig[catId].children.ageGroups.length }} فئات عمرية)
        </span>
      </li>
    </ul>
  </div>

  <!-- Wizard Buttons -->
  <div class="wizard-buttons">
    <button class="btn secondary" (click)="goBack()" [disabled]="currentStep === 1">السابق</button>
    <button class="btn primary" *ngIf="currentStep < 3" (click)="goNext()">التالي</button>
    <button class="btn success" *ngIf="currentStep === 3" (click)="onSubmit()">حفظ المسابقة</button>
  </div>
</div>

<!-- Existing Competitions List -->
<div class="container card">
  <h2>قائمة المسابقات</h2>
  <table class="competition-table">
    <thead>
      <tr>
        <th>الاسم</th>
        <th>النوع</th>
        <th>الفئات</th>
        <th>تاريخ البداية</th>
        <th>تاريخ النهاية</th>
        <th>الإجراءات</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let comp of competitions">
        <td>{{ comp.title }}</td>
        <td>{{ comp.type }}</td>
        <td>{{ getCategoryNames(comp) }}</td>
        <td>{{ formatDate(comp.startDate) }}</td>
        <td>{{ formatDate(comp.endDate) }}</td>
        <td>
          <button class="btn small secondary" (click)="openAssignments(comp)">تعيين اللجان</button>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Jury Assignment Modal -->
<div class="modal" *ngIf="showAssignmentsModal">
  <div class="modal-backdrop" (click)="closeAssignments()"></div>
  <div class="modal-panel card">
    <h3>تعيين اللجان للمسابقة: {{ selectedCompetition?.title }}</h3>

    <p *ngIf="loadingAssignments">جاري التحميل...</p>

    <div *ngIf="!loadingAssignments">
      <!-- Existing Assignments -->
      <div *ngIf="assignments.length === 0" class="empty">لا توجد تعيينات حالياً</div>

      <div *ngFor="let a of assignments" class="assignment">
        <strong>
          {{ getCategoryNameById(a.categoryId) }} - {{ formatSubCategory(a.subCategory!) }}
        </strong>
        <span>القاعـة: {{ a.classRoom || '-' }}</span>
        <br />
        <small>
          الأعضاء:
          <span *ngFor="let m of a.juryMembers; let last = last">
            {{ getUserNameById(m.userId) }} ({{ m.role === 'president' ? 'رئيس' : 'عضو' }})<span *ngIf="!last">, </span>
          </span>
        </small>
        <button class="btn small danger" (click)="deleteAssignment(a._id!)">حذف</button>
        <hr />
      </div>

      <!-- Add New Assignments for all Subcategories -->
      <div class="new-assignment">
        <h4>إضافة تعيين جديد لكل فئة فرعية</h4>
        
        <div *ngIf="availableSubCategories.length === 0" class="success-message">
          ✅ تم تعيين اللجان لجميع الفئات الفرعية
        </div>

        <div *ngFor="let sc of availableSubCategories" class="sub-category-card">
          <h4>{{ sc.label }}</h4>

          <label>القاعـة</label>
          <input type="text" [(ngModel)]="sc.classRoom" placeholder="مثال: A101" />

          <label>رئيس اللجنة (فقط من يمكنهم الترؤس)</label>
          <select [(ngModel)]="sc.presidentId">
            <option value="">اختر الرئيس</option>
            <option *ngFor="let u of getPresidentCandidates()" [value]="u._id">
              {{ u.firstName }} {{ u.lastName }} 
              <span *ngIf="u.expertiseLevel">(خبرة: {{ u.expertiseLevel }}/10)</span>
            </option>
          </select>

          <div class="jury-filters">
            <label>
              <strong>فلترة الأعضاء:</strong>
            </label>
            <label>
              الحد الأدنى للخبرة:
              <input type="number" [(ngModel)]="sc.minExpertise" min="1" max="10" placeholder="1-10" />
            </label>
          </div>

          <label>الأعضاء</label>
          <select multiple [(ngModel)]="sc.juryMembers" size="8">
            <option 
              *ngFor="let u of getFilteredJuryMembers(sc)" 
              [value]="u._id"
              [disabled]="u._id === sc.presidentId"
            >
              {{ u.firstName }} {{ u.lastName }}
              <span *ngIf="u.expertiseLevel"> - خبرة: {{ u.expertiseLevel }}/10</span>
              <span *ngIf="u.canBePresident"> ⭐</span>
            </option>
          </select>
          <small class="hint">⭐ = يمكنه الترؤس | الرئيس غير قابل للاختيار كعضو | اضغط Ctrl/Cmd لاختيار متعدد</small>

          <button class="btn success" (click)="addAssignmentForSubCategory(sc)">إضافة التعيين</button>
          <hr />
        </div>
      </div>
    </div>

    <button class="btn secondary" (click)="closeAssignments()">إغلاق</button>
  </div>
</div>
